{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ‚Äì –æ–±–∑–æ—Ä{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    <p class="muted">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="stats-grid">
    <div class="stat-card stat-card-primary">
        <div class="stat-icon">üõ°Ô∏è</div>
        <div class="stat-content">
            <div class="stat-label">–í—Å–µ–≥–æ —É–≥—Ä–æ–∑</div>
            <div class="stat-value">{{ stats.get('total_threats', 0) }}</div>
            <div class="stat-sublabel">
                <span>–•—ç—à–∏: {{ stats.get('malicious_hashes', 0) }}</span>
                <span>URL: {{ stats.get('malicious_urls', 0) }}</span>
            </div>
        </div>
    </div>
    
    <div class="stat-card stat-card-success">
        <div class="stat-icon">üîë</div>
        <div class="stat-content">
            <div class="stat-label">API –∫–ª—é—á–∏</div>
            <div class="stat-value">{{ stats.get('active_api_keys', 0) }}</div>
            <div class="stat-sublabel">–ó–∞–ø—Ä–æ—Å–æ–≤: {{ stats.get('total_requests', 0) or 0 }}</div>
        </div>
    </div>
    
    <div class="stat-card stat-card-info">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
            <div class="stat-label">–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</div>
            <div class="stat-value">{{ stats.get('whitelist_entries', 0) }}</div>
            <div class="stat-sublabel">–•–∏—Ç–æ–≤: {{ stats.get('whitelist_hits', 0) | default(0) }}</div>
        </div>
    </div>
    
    <div class="stat-card stat-card-warning">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-content">
            <div class="stat-label">–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</div>
            <div class="stat-value">{{ stats.get('blacklist_entries', 0) }}</div>
            <div class="stat-sublabel">–•–∏—Ç–æ–≤: {{ stats.get('blacklist_hits', 0) | default(0) }}</div>
        </div>
    </div>
    
    <div class="stat-card stat-card-info">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-content">
            <div class="stat-label">–û—Ç–∑—ã–≤—ã</div>
            <div class="stat-value">{{ stats.get('total', 0) }}</div>
            <div class="stat-sublabel">–°—Ä–µ–¥–Ω—è—è: {{ "%.1f"|format(stats.get('average_rating', 0)) }}/5</div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
<div class="charts-grid">
    <div class="chart-card">
        <h2>–ó–∞–ø—Ä–æ—Å—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
        <canvas id="requestsChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h2>–°—Ç–∞—Ç—É—Å –∫–æ–¥—ã</h2>
        <canvas id="statusCodesChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h2>–¢–∏–ø—ã —É–≥—Ä–æ–∑</h2>
        <canvas id="threatTypesChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h2>–ö—ç—à (—Ö–∏—Ç—ã/–∑–∞–ø–∏—Å–∏)</h2>
        <canvas id="cacheChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h2>–û—Ç–∑—ã–≤—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
        <canvas id="reviewsChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h2>
        <canvas id="ratingsChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h2>–û—Ç–∑—ã–≤—ã –ø–æ –≤–µ—Ä—Å–∏—è–º</h2>
        <canvas id="reviewsVersionChart"></canvas>
    </div>
</div>

<!-- –ö—ç—à –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="row">
    <div class="card col-large">
        <h2>–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ (hover-cache)</h2>
        <div class="cache-stats">
            <div class="cache-stat-item">
                <div class="cache-stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                <div class="cache-stat-value">{{ stats.get('total_cache_entries', 0) }}</div>
            </div>
            <div class="cache-stat-item">
                <div class="cache-stat-label">–í—Å–µ–≥–æ —Ö–∏—Ç–æ–≤</div>
                <div class="cache-stat-value">{{ stats.get('total_cache_hits', 0) }}</div>
            </div>
            <div class="cache-stat-item">
                <div class="cache-stat-label">–†–∞–∑–º–µ—Ä (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)</div>
                <div class="cache-stat-value">{% set mb = ((stats.get('bytes_estimated', 0) or 0) / 1024 / 1024) %}{{ "%.2f"|format(mb) }} MB</div>
            </div>
        </div>
        <form method="post" action="/cache/refresh" class="cache-form">
            <label>–ß—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å</label>
            <select name="target">
                <option value="all" selected>–ë–µ–ª—ã–π –∏ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–∫–∏</option>
                <option value="whitelist">–¢–æ–ª—å–∫–æ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</option>
                <option value="blacklist">–¢–æ–ª—å–∫–æ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</option>
            </select>
            <label>–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å (—Å—Ç–∞—Ä–µ–π—à–∏–µ)</label>
            <input type="number" name="limit" min="1" max="50" value="10" />
            <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É</button>
            <p class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é: –º—ã –ø–µ—Ä–µ—Å–∫–∞–Ω–∏—Ä—É–µ–º N —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ VirusTotal –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ–º –∏—Ö –≤ –±–∞–∑–µ.</p>
        </form>
    </div>
    
    <div class="card col-small">
        <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <div class="action-buttons">
            <button class="action-btn" onclick="window.location.href='/keys'">
                <span class="action-icon">üîë</span>
                <span>–°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á</span>
            </button>
            <button class="action-btn" onclick="window.location.href='/threats'">
                <span class="action-icon">‚ö†Ô∏è</span>
                <span>–î–æ–±–∞–≤–∏—Ç—å —É–≥—Ä–æ–∑—É</span>
            </button>
            <button class="action-btn" onclick="window.location.href='/reviews'">
                <span class="action-icon">‚≠ê</span>
                <span>–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∑—ã–≤–æ–≤</span>
            </button>
            <button class="action-btn action-btn-danger" onclick="window.location.href='/danger'">
                <span class="action-icon">üóëÔ∏è</span>
                <span>–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    fetch('/api/dashboard/chart-data')
        .then(response => response.json())
        .then(data => {
            // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            const requestsCtx = document.getElementById('requestsChart').getContext('2d');
            const requestsData = data.requests_over_time || [];
            new Chart(requestsCtx, {
                type: 'line',
                data: {
                    labels: requestsData.map(item => item.date),
                    datasets: [{
                        label: '–ó–∞–ø—Ä–æ—Å–æ–≤',
                        data: requestsData.map(item => item.count),
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å –∫–æ–¥–æ–≤
            const statusCtx = document.getElementById('statusCodesChart').getContext('2d');
            const statusData = data.status_codes || {};
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusData),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(168, 85, 247, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —Ç–∏–ø–æ–≤ —É–≥—Ä–æ–∑
            const threatCtx = document.getElementById('threatTypesChart').getContext('2d');
            const threatData = data.threat_types || {};
            new Chart(threatCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(threatData),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: Object.values(threatData),
                        backgroundColor: 'rgba(239, 68, 68, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –∫—ç—à–∞
            const cacheCtx = document.getElementById('cacheChart').getContext('2d');
            const cacheData = data.cache_ratio || {};
            new Chart(cacheCtx, {
                type: 'pie',
                data: {
                    labels: ['–•–∏—Ç—ã', '–ó–∞–ø–∏—Å–∏'],
                    datasets: [{
                        data: [cacheData.hits || 0, cacheData.entries || 0],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            const reviewsCtx = document.getElementById('reviewsChart').getContext('2d');
            const reviewsData = data.reviews_over_time || [];
            new Chart(reviewsCtx, {
                type: 'line',
                data: {
                    labels: reviewsData.map(item => item.date),
                    datasets: [
                        {
                            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤',
                            data: reviewsData.map(item => item.count),
                            borderColor: 'rgb(251, 191, 36)',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞',
                            data: reviewsData.map(item => item.avg_rating),
                            borderColor: 'rgb(168, 85, 247)',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: '–û—Ü–µ–Ω–∫–∞'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫
            const ratingsCtx = document.getElementById('ratingsChart').getContext('2d');
            const reviewsStats = data.reviews_stats || {};
            const ratingDist = reviewsStats.rating_distribution || {};
            const ratingLabels = ['1', '2', '3', '4', '5'];
            const ratingCounts = ratingLabels.map(r => ratingDist[r] || 0);
            new Chart(ratingsCtx, {
                type: 'bar',
                data: {
                    labels: ratingLabels.map(r => r + ' ‚≠ê'),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤',
                        data: ratingCounts,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ –≤–µ—Ä—Å–∏—è–º
            const reviewsVersionCtx = document.getElementById('reviewsVersionChart').getContext('2d');
            const reviewsByVersion = data.reviews_by_version || {};
            const versionLabels = Object.keys(reviewsByVersion);
            const versionCounts = Object.values(reviewsByVersion);
            new Chart(reviewsVersionCtx, {
                type: 'doughnut',
                data: {
                    labels: versionLabels,
                    datasets: [{
                        data: versionCounts,
                        backgroundColor: [
                            'rgba(37, 99, 235, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(20, 184, 166, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(14, 165, 233, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
});
</script>
{% endblock %}
